## 网络层协议

### 网络层的功能

- 主要功能：分组转发和路由选择
- 其它功能：不同系统的设备间通信、拥塞控制

### `IPv4`协议

- `IP`地址：在此介绍`ipv4`的`32`位地址(`ipv6`为`128`位)，由**网络号**和**主机号**组成，分为**有类别**和**无类别**两种地址；注意，网络层始终讲述的是不同的网络号间如何转发，并不关心同一网段下的不同主机如何转发(那是数据链路层的任务)

  - 有两种特殊的主机号**不能分配给主机**：全零和全一
    主机号全零的`IP`地址表示**一个网段本身**
    主机号全一的`IP`地址表示**特定子网的广播地址**，可以**跨网段广播**到特定网段的所有主机号(但这个功能**默认被拦截**，需要管理员开放)
  - 有两个特殊的`IP`地址有特殊用途：
    `0.0.0.0`表示**本地网段内的所有主机**，通常作为路由器的**默认路由**
    `255.255.255.255`表示**受限广播地址**，和仅主机号全一的`IP`地址相比，它**只能在本地网段广播**该分组、而后者可以
  - 有类别(比较古老的做法)：分为**`A、B、C、D、E`**类，`A、B、C`类分别以**前`8、16、24`位**作为网络号
    为了区分不同的有类别地址，它们有不同的**前缀**，分别为**`0、10、110、1110、1111`**
    `A`类总共提供$2^7=128$个网络号，$2^{24}=16777216$个主机号
    `B`类总共提供$2^{14}=16384$个网络号，$2^{16}=65536$个主机号
    `C`类总共提供$2^{21}=2097152$个网络号，$2^{8}=256$个主机号
    缺陷显而易见，非常不灵活，例如：当出现$10^3$量级的主机号数量需求时，显然只能用`B`类，导致白白浪费一个网段的大部分主机号
    `D`类和`E`类不区分网络号和主机号，它们的后`28`位可以随意修改，`D`给因特网体系结构委员会使用，`E`类作为保留地址
  - 无类别：网络号位数$x$可变的`IP`地址，用于无类别域间路由选择(`Classless Inter Domain Routing, CIDR`)
    为了区分不同的无类别地址，不同网段由不同的**子网掩码**来标识，子网掩码是**网络号全为`1`、主机号全为`0`**的`32`位掩码，所谓子网掩码的长度指的是$x$的大小
    无类别地址简记形式：$a.b.c.d/x$，$x$为网络号长度
    如果主机号数量的需求为$L$，则找到$2^{k-1}-2<L\le2^k-2$，其中的$k$即最少需要的主机号位数，因此子网掩码最长为$x=32-k$

- `IPv4`报文：

  - 第一行：版本号(`4`)+首部长度(`4`)+服务类型(`8`)+数据报长度(`16`)

    - 版本号：处于不同版本的兼容，版本号用于标识使用的`IP`协议版本
    - 首部长度：单位为`4`个字节
    - 服务类型：区分不同的`IP`报文，提供不同的优先级
    - 数据报长度：单位为`1`个字节

  - 第二行：标识(`16`)+标志(`3`)+片偏移(`13`)，用于`IP`分组(分片)，由于分片/重组相当耗时，`ipv6`不允许在中间路由进行`IP`分片，这一行字段被弃用，但应该了解分组的过程：

    - 标识：分割出去的分组的该字段继承原`IP`分组的标识
    - 标志位：包含保留位、`DF`位(不分片位)和`MF`位(更多分片位)
      `DF`置`1`则不允许分片，并在数据大小超过`MTU`后返回`ICMP`错误信息
      `MF`置`1`表示本分组是分片后的分组，且后续还有分组未到达
      `MF`置`0`表示本分组是分片后的分组，且后续没有更多分片，`MF`方便重组方能够确认原来分组的大小
    - 片偏移：标识本分组首字节在原分组首字节的位置，这个字段的单位是`8`个字节(因为`13`位比数据报长度`16`位少了`3`位)，即实际位置是片偏移乘`8`
      也因为这个，每个分片(除最后一个分片)的**有效数据大小必须能被`8`整除**

    本身分组分割就是因为要使`IP`分组小于`MTU`，因此要使分片的有效数据大小$L$满足：
    $L_{max}+首部长度\le MTU$且$8|L_{max}$

  - 第三行：`TTL`(`8`)+上层协议(`8`)+首部检验和(`16`)

    - `TTL`：`Time-To-Live`，一个分组的最长寿命，每经过一个路由减少一定寿命，防止分组永久地在网络中循环转发

  - 第三、第四行：源`IP`地址、目的`IP`地址

### 路由器工作原理

- 分组从一个网段到另一个网段，可能需要经过路由器转发
  路由器需要先经过**路由选择**，才能进行**转发**

  - 路由选择：通过软件计算，选择一条从源主机到目的主机的端到端路径
  - 转发：将分组从入接口移动到某个离出接口(由路由选择决定向哪个接口移动)，这是一次较快的硬件操作

- 静态转发表：由目标网络、子网掩码、下一站`IP`地址、离出接口组成
  静态是指，由管理者手动增删表项

  - 目标**网络号**：标识本路由器可以到达的网段，通过使分组的目的`IP`地址和表项的子网掩码按位相与再和目标网络比对，得出离出接口
    用`0.0.0.0`表示默认路由，即没有任何表项和分组的目的`IP`网段相匹配的时候，使用的表项
  - 下一站**`IP`地址**：标识下一个路由**设备接口的`IP`地址**，这个是整个`IP`地址而不仅是网络号
    每个路由器的**每个接口都有`IP`地址**，这个字段表示的就是接口的`IP`地址
    `C`表示下一个接口就在本地路由器，即目的网段和本路由器相邻
  - 离出接口：即本地对接口的标识

- 路由聚合和最长子网掩码匹配：有些时候，一个路由器有**多个表项的离出接口相同**，**目标网络不同但有一定长度的公共前缀**，这时可以进行**路由聚合**，将它们合为一个表项，因为它们虽然目的网段不同，但是转发结果是一致的，而路由表越短、传输延迟越短
  但可能会出现问题：分组本应转发到接口`A`，但因为接口`B`的表项被路由聚合了，同时意味着这些表项的子网掩码变短了，按位相与后分组可能被误转发到接口`B`；**最长子网掩码匹配**即，分组**总是先和子网掩码较长的表项**比对，因为较长的子网掩码通常包含更详细的地址信息

- 动态路由选择算法：仅少数表项由管理者初始化，其余表项由路由器学习得到

  - 集中式路由选择算法，又称**链路状态(`LS`)算法**：在路由开始学习前**知道了所有链路的开销**，使用`Dijkstra`算法学习
    学习完成后，路由器可以得知**和其它所有网段的最短距离**以及**最合适的离出接口**
  - 分布式路由选择算法，又称**距离向量(`DV`)算法**：使用`Bellman-Ford`算法，通过报文跳数估计距离，适用于**中小型网络**
  - `LS`和`DV`算法对比：
    更新开销方面：前者需要向所有路由转发链路状态报文、后者只在相邻的链路发生改变时向相邻的路由器报告，后者开销较小
    收敛速度和健壮性方面：前者较优，`DV`算法收敛很慢

- 自治系统：因特网是多个`ISP`(网络业务提供商)的网络，不同`ISP`有自己的管理方式，因此出现了自治域(`Autonomous System, AS`)
  `AS`内部有**一类**路由选择协议，它们统称为**`IGP`**(`Interior Gateway Protocol`内部网关协议)；不同`AS`间需要用**统一的**路由选择协议管理，称为**`BGP`**(`Border Gateway Protocol`边界网关协议)
  即，`IGP`是一类开发商自行实现的协议、`BGP`是一个由`RFC`规范的协议，`IGP`有以下协议：

  - 路由信息协议(`Routing Information Protocol, RIP`)：它是一个`DV`协议，仅适用于中小型网络
  - 内部网关路由协议(`Interior Gateway Routing Protocol, IGRP`)：它是一个`DV`协议，现在已经被淘汰，注意和`IGP`区分
  - 开放最短路优先(`Open Shortest Path First, OSPF`)：`Open`意味着这个协议的实现细节是所有人可见的，它是一个`LS`协议，适用于大型网络，支持分层拓扑架构
  - 中间系统到中间系统(`IS-IS`)：它是一个`LS`协议

  `BGP`规定的边界网关的路由表经过高度路由聚合

### `DHCP`协议

- `DHCP`协议全称`Dynamic Host Configuration Protocol`，即**动态主机配置**协议，又称**即插即用**(`plug-and-play`)或**零配置**(`zeroconf`)协议
  `DHCP`为随时进入局域网的设备**自动配置`IP`地址**、设备离开后自动回收`IP`地址
- 发现报文：主机进入局域网后，没有`IP`地址可用，也不知道该网段的网络号，于是向该局域网内的**`DHCP`主机**通过**`UDP`**协议**广播`DHCP`发现报文**(端口号`67`)，使用**`0.0.0.0`作为本机地址**
- 提供报文：`DHCP`主机收到后(只有`DHCP`主机会进行处理)，仍用**广播**方式响应一个**`DHCP`提供报文**，其中在数据段附上推荐的`IP`地址，以及其它的限制如**`IP`地址租用期**
- 请求报文：局域网内可能有若干个`DHCP`主机，新进入的主机收到多个`DHCP`提供报文后，**尝试**选择一个`IP`地址作为自己的`IP`地址，并**广播**发送**`DHCP`请求报文**，并仍使用`0.0.0.0`作为本机地址
  - 使用`0.0.0.0`作为源地址的原因：需要得到`DHCP`的认可后才能正式租用该`IP`地址
  - 使用`255.255.255.255`作为目的地址的原因：因为可能有多个`DHCP`服务器，广播是为了让其它未被选择的`DHCP`主机也接收到租用请求报文，更新它们的可用`IP`表
- 响应报文：只有被选中的`DHCP`主机会用**广播**形式发送**`DHCP`响应报文**，交互完毕后，新主机就可以使用租用的`IP`地址了；在租用期结束前，新主机可能再次发送请求报文进行续租
  仍用广播，是因为新主机还没有正式租用`IP`地址

### `NAT`

- `NAT`全称`Network Address Translation`，即**网络地址转换**
  用于**搭建专用网络**，专用网络内的所有主机的`IP`地址对外界都不可见，仅有一个`NAT`路由器有合法的`IP`地址
  可以节省网络号，但`NAT`是基于`TCP`或`UDP`端口号实现的，在面对不经过传输层的通信要求时需要额外配置
- 对于专用网络内部，一切通信都是正常的，当需要和外部通信时，`NAT`路由将所有`IP`分组的源`IP`地址改为`NAT`路由的`IP`地址，并将里面的端口号改为一个由`NAT`路由服务器新分配的端口号
  同时通过`NAT`转发表，维护从**`NAT`路由端口号**到**内部主机`IP`及原端口号**的映射
  最后在接收来自外部的报文时，将目的`IP`地址和目的端口号再映射回去

### `ICMP`

- `ICMP`全称`Internet Control Message Protocol`，即**因特网控制报文协议**，通常用于差错报告
- `ping`就是用`ICMP`实现的，通过发送类型`8`编码`0`的回显请求到目的主机，目的主机发送类型`0`编码`0`的回显回答来实现
- `Traceroute`也是通过`ICMP`实现的，源主机通过逐渐增大`UDP`分组的`TTL`来发现到某个目的主机之间的所有路由，路由收到`TTL`恰好降为`0`的分组时，报告一个类型`11`编码`0`的`TTL`过期报文，主机就可以知道到这个路由的时延、包括该路由的`IP`地址
  当`TTL`足够大以至于到达目的主机时，`Traceroute`刻意将`UDP`分组的端口号设置为不可达端口号，因此目的主机会报告一个表示目的端口不可达的`ICMP`报文，当源主机收到该报文时，就知道不用再发送`UDP`探测报文了

### `ARP`和`RARP`